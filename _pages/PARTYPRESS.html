---
permalink: /partypress/
title: "PARTYPRESS Database"
excerpt: "Visualization of parties' issue agendas"
---
<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.controls {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
}
.selector-container {
    margin-bottom: 15px;
}
.selector-title {
    font-weight: bold;
    margin-bottom: 5px;
}
.checkbox-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 6px;
    border-radius: 4px;
    background-color: white;
}
.select-item {
    margin-bottom: 0px;
    font-size: 0.55em;
    cursor: pointer;
    padding: 1px 3px;
    border-radius: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    position: relative;
}
.select-item:hover {
    background-color: #f0f0f0;
}
.select-item.selected {
    background-color: #d4edda;
    color: #155724;
}
.select-item .party-id {
    display: none;
}
.select-item:hover .party-id {
    display: inline;
}
.select-all-button {
    margin-bottom: 5px;
    padding: 2px 5px;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 3px;
    font-size: 0.6em;
    cursor: pointer;
}
.select-all-button:hover {
    background-color: #dde2e6;
}
.function-buttons {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.function-button {
    padding: 3px 8px;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 3px;
    font-size: 0.7em;
    cursor: pointer;
}
.function-button:hover {
    background-color: #dde2e6;
}
.function-button.active {
    background-color: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
}
.chart-container {
    margin: 20px 0;
    height: 400px;
}
.issues-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
}
.parties-container {
    display: flex;
    flex-wrap: nowrap;
    gap: 5px;
    overflow-x: auto;
    padding-bottom: 5px;
}
.country-column {
    flex: 0 0 auto;
    min-width: 50px;
    max-width: 60px;
}
.country-header {
    font-weight: bold;
    padding: 1px;
    background-color: #e9ecef;
    border-radius: 2px;
    margin-bottom: 1px;
    text-align: center;
    font-size: 0.65em;
    cursor: pointer;
}
.country-header:hover {
    background-color: #dde2e6;
}
.country-header.selected {
    background-color: #d4edda;
    color: #155724;
}
.chart-legend {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
}
.legend-item {
    display: flex;
    align-items: center;
    font-size: 0.8em;
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 3px;
}
.legend-item:hover {
    background-color: #e9ecef;
}
.legend-color {
    width: 12px;
    height: 12px;
    margin-right: 5px;
    border-radius: 2px;
}
.legend-hidden {
    opacity: 0.5;
    text-decoration: line-through;
}
</style>
</head>
<body>
<p>This page visualizes parties' issue agendas based on the PARTYPRESS Database.</p>
<h2>Interactive Visualization</h2>
<div class="controls">
    <div class="selector-container">
        <div class="selector-title">Select Issues:</div>
        <div id="issue-checkboxes" class="checkbox-container">
            <button id="select-all-issues" class="select-all-button" onclick="toggleAllIssues()">Select All Issues</button>
            <div id="issue-list" class="issues-grid">
                <div class="select-item" data-value="1" onclick="toggleSelection(this)">1 - Macroeconomics</div>
                <div class="select-item" data-value="2" onclick="toggleSelection(this)">2 - Civil Rights</div>
                <div class="select-item" data-value="3" onclick="toggleSelection(this)">3 - Health</div>
                <div class="select-item" data-value="4" onclick="toggleSelection(this)">4 - Agriculture</div>
                <div class="select-item" data-value="5" onclick="toggleSelection(this)">5 - Labor</div>
                <div class="select-item" data-value="6" onclick="toggleSelection(this)">6 - Education</div>
                <div class="select-item" data-value="7" onclick="toggleSelection(this)">7 - Environment</div>
                <div class="select-item" data-value="8" onclick="toggleSelection(this)">8 - Energy</div>
                <div class="select-item" data-value="9" onclick="toggleSelection(this)">9 - Immigration</div>
                <div class="select-item" data-value="10" onclick="toggleSelection(this)">10 - Transportation</div>
                <div class="select-item" data-value="12" onclick="toggleSelection(this)">12 - Law and Crime</div>
                <div class="select-item" data-value="13" onclick="toggleSelection(this)">13 - Social Welfare</div>
                <div class="select-item" data-value="14" onclick="toggleSelection(this)">14 - Housing</div>
                <div class="select-item" data-value="15" onclick="toggleSelection(this)">15 - Domestic Commerce</div>
                <div class="select-item" data-value="16" onclick="toggleSelection(this)">16 - Defense</div>
                <div class="select-item" data-value="17" onclick="toggleSelection(this)">17 - Technology</div>
                <div class="select-item" data-value="18" onclick="toggleSelection(this)">18 - Foreign Trade</div>
                <div class="select-item" data-value="19.1" onclick="toggleSelection(this)">19.1 - International Affairs</div>
                <div class="select-item" data-value="19.2" onclick="toggleSelection(this)">19.2 - European Integration</div>
                <div class="select-item" data-value="20" onclick="toggleSelection(this)">20 - Government Operations</div>
                <div class="select-item" data-value="23" onclick="toggleSelection(this)">23 - Culture</div>
                <div class="select-item" data-value="98" onclick="toggleSelection(this)">98 - Non-thematic</div>
                <div class="select-item" data-value="99" onclick="toggleSelection(this)">99 - Other</div>
            </div>
        </div>
    </div>
    
    <div class="selector-container">
        <div class="selector-title">Select Parties:</div>
        <div id="party-checkboxes" class="checkbox-container">
            <button id="select-all-parties" class="select-all-button" onclick="toggleAllParties()">Select All Parties</button>
            <div id="party-list" class="parties-container">
                <div class="select-item">Loading parties...</div>
            </div>
        </div>
    </div>
    
    <div class="function-buttons">
        <button id="smooth-button" class="function-button" onclick="toggleSmoothing()">Smooth Data</button>
        <button id="country-avg-button" class="function-button" onclick="toggleCountryAverages()">Within-Country Averages</button>
        <button id="export-button" class="function-button" onclick="exportToCSV()">Export to CSV</button>
    </div>
</div>
<div class="chart-container">
    <canvas id="issue-chart"></canvas>
    <div id="chart-legend" class="chart-legend"></div>
</div>
<script>
let allData = null;
let partyInfo = null;
let chart = null;
let smoothingEnabled = false;
let countryAveragesEnabled = false;

function toggleAllParties() {
    const selectAll = !document.querySelector('#party-list .select-item.selected');
    const items = document.querySelectorAll('#party-list .select-item');
    
    items.forEach(item => {
        if (selectAll) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
    
    updateData();
}

const countryISOCodes = {
    "austria": "AT",
    "belgium": "BE",
    "bulgaria": "BG",
    "croatia": "HR",
    "cyprus": "CY",
    "czech republic": "CZ",
    "denmark": "DK",
    "estonia": "EE",
    "finland": "FI",
    "france": "FR",
    "germany": "DE",
    "greece": "GR",
    "hungary": "HU",
    "ireland": "IE",
    "italy": "IT",
    "latvia": "LV",
    "lithuania": "LT",
    "luxembourg": "LU",
    "malta": "MT",
    "netherlands": "NL",
    "poland": "PL",
    "portugal": "PT",
    "romania": "RO",
    "slovakia": "SK",
    "slovenia": "SI",
    "spain": "ES",
    "sweden": "SE",
    "uk": "GB"
};

const colors = [
    'rgb(75, 192, 192)',
    'rgb(255, 99, 132)',
    'rgb(54, 162, 235)',
    'rgb(255, 206, 86)',
    'rgb(153, 102, 255)',
    'rgb(255, 159, 64)',
    'rgb(75, 192, 75)',
    'rgb(192, 75, 192)',
    'rgb(75, 75, 192)',
    'rgb(192, 192, 75)'
];

const partyColors = {
    "CDU": "rgb(0, 0, 0)",
    "CSU": "rgb(0, 0, 0)",
    "SPD": "rgb(255, 0, 0)",
    "FDP": "rgb(255, 215, 0)",
    "Die Linke": "rgb(128, 0, 128)",
    "Grüne": "rgb(0, 128, 0)",
    "AfD": "rgb(0, 0, 255)",
    
    "Les Républicains": "rgb(0, 0, 128)",
    "Parti Socialiste": "rgb(255, 0, 0)",
    "La République En Marche": "rgb(0, 128, 255)",
    "Rassemblement National": "rgb(0, 0, 0)",
    
    "Conservative": "rgb(0, 0, 128)",
    "Labour": "rgb(255, 0, 0)",
    "Liberal Democrat": "rgb(255, 165, 0)",
    "Scottish National": "rgb(255, 215, 0)",
    "SNP": "rgb(255, 215, 0)",
    "Plaid Cymru": "rgb(0, 128, 0)",
    "UKIP": "rgb(128, 0, 128)",
    "Brexit": "rgb(128, 0, 128)",
    
    "Forza Italia": "rgb(0, 0, 255)",
    "Partito Democratico": "rgb(255, 0, 0)",
    "Lega": "rgb(0, 128, 0)",
    "Fratelli d'Italia": "rgb(0, 0, 0)",
    "Movimento 5 Stelle": "rgb(255, 215, 0)",
    
    "Partido Popular": "rgb(0, 0, 128)",
    "Partido Socialista": "rgb(255, 0, 0)",
    "Ciudadanos": "rgb(0, 128, 255)",
    "Podemos": "rgb(128, 0, 128)",
    "Vox": "rgb(0, 0, 0)",
    
    "VVD": "rgb(0, 0, 128)",
    "CDA": "rgb(0, 128, 0)",
    "PVDA": "rgb(255, 0, 0)",
    "D66": "rgb(0, 128, 255)",
    "PVDD": "rgb(0, 128, 0)",
    "SP": "rgb(255, 0, 0)",
    "GroenLinks": "rgb(0, 128, 0)",
    "FVD": "rgb(0, 0, 0)",
    
    "Socialdemokraterna": "rgb(255, 0, 0)",
    "Moderaterna": "rgb(0, 0, 128)",
    "Centerpartiet": "rgb(0, 128, 0)",
    "Vänsterpartiet": "rgb(128, 0, 128)",
    "Kristdemokraterna": "rgb(0, 128, 0)",
    "Liberalerna": "rgb(0, 128, 255)",
    "Miljöpartiet": "rgb(0, 128, 0)",
    "Sverigedemokraterna": "rgb(0, 0, 0)",
    
    "ÖVP": "rgb(0, 0, 0)",
    "SPÖ": "rgb(255, 0, 0)",
    "FPÖ": "rgb(0, 0, 128)",
    "Die Grünen": "rgb(0, 128, 0)",
    "NEOS": "rgb(255, 165, 0)",
    
    "CD&V": "rgb(0, 0, 0)",
    "Open Vld": "rgb(0, 128, 255)",
    "N-VA": "rgb(255, 215, 0)",
    "VB": "rgb(0, 0, 0)",
    "PS": "rgb(255, 0, 0)",
    "MR": "rgb(0, 128, 255)",
    "Ecolo": "rgb(0, 128, 0)",
    "Groen": "rgb(0, 128, 0)",
    
    "Venstre": "rgb(0, 128, 255)",
    "Socialdemokraterne": "rgb(255, 0, 0)",
    "Dansk Folkeparti": "rgb(0, 0, 0)",
    "Radikale Venstre": "rgb(0, 128, 255)",
    "Enhedslisten": "rgb(128, 0, 128)",
    "Alternativet": "rgb(0, 128, 0)",
    
    "Kokoomus": "rgb(0, 0, 128)",
    "SDP": "rgb(255, 0, 0)",
    "Perussuomalaiset": "rgb(0, 0, 0)",
    "Keskusta": "rgb(0, 128, 0)",
    "Vihreät": "rgb(0, 128, 0)",
    "Vasemmistoliitto": "rgb(128, 0, 128)",
    
    "ND": "rgb(0, 0, 128)",
    "SYRIZA": "rgb(128, 0, 128)",
    "KINAL": "rgb(255, 0, 0)",
    "KKE": "rgb(255, 0, 0)",
    "Elliniki Lysi": "rgb(0, 0, 0)",
    
    "Fine Gael": "rgb(0, 128, 255)",
    "Fianna Fáil": "rgb(0, 128, 0)",
    "Sinn Féin": "rgb(0, 128, 0)",
    "Labour": "rgb(255, 0, 0)",
    "Green": "rgb(0, 128, 0)",
    
    "PiS": "rgb(0, 0, 128)",
    "PO": "rgb(0, 128, 255)",
    "SLD": "rgb(255, 0, 0)",
    "PSL": "rgb(0, 128, 0)",
    "Nowoczesna": "rgb(0, 128, 255)",
    "Lewica": "rgb(255, 0, 0)",
    
    "PS": "rgb(255, 0, 0)",
    "PSD": "rgb(0, 0, 128)",
    "CDS-PP": "rgb(0, 0, 0)",
    "BE": "rgb(128, 0, 128)",
    "PCP": "rgb(255, 0, 0)",
    "PAN": "rgb(0, 128, 0)",
    
    "PSD": "rgb(255, 0, 0)",
    "PNL": "rgb(0, 0, 128)",
    "USR": "rgb(0, 128, 255)",
    "UDMR": "rgb(0, 128, 0)",
    "ALDE": "rgb(0, 128, 255)",
    
    "Smer-SD": "rgb(255, 0, 0)",
    "SaS": "rgb(0, 128, 255)",
    "OĽaNO": "rgb(0, 128, 255)",
    "Kotleba": "rgb(0, 0, 0)",
    "SNS": "rgb(0, 0, 0)",
    
    "SDS": "rgb(0, 0, 128)",
    "SD": "rgb(255, 0, 0)",
    "Levica": "rgb(255, 0, 0)",
    "SMC": "rgb(0, 128, 255)",
    "NSi": "rgb(0, 0, 0)",
    
    "ANO": "rgb(0, 128, 255)",
    "ODS": "rgb(0, 0, 128)",
    "ČSSD": "rgb(255, 0, 0)",
    "KSČM": "rgb(255, 0, 0)",
    "TOP 09": "rgb(0, 128, 255)",
    "SPD": "rgb(0, 0, 0)",
    
    "Fidesz": "rgb(0, 0, 128)",
    "Jobbik": "rgb(0, 0, 0)",
    "MSZP": "rgb(255, 0, 0)",
    "DK": "rgb(0, 128, 255)",
    "LMP": "rgb(0, 128, 0)",
    
    "HDZ": "rgb(0, 0, 128)",
    "SDP": "rgb(255, 0, 0)",
    "Most": "rgb(0, 128, 255)",
    "Živi zid": "rgb(0, 0, 0)",
    
    "GERB": "rgb(0, 0, 128)",
    "BSP": "rgb(255, 0, 0)",
    "DPS": "rgb(0, 128, 0)",
    "Volya": "rgb(0, 0, 0)",
    
    "DISY": "rgb(0, 0, 128)",
    "AKEL": "rgb(255, 0, 0)",
    "DIKO": "rgb(0, 128, 255)",
    "EDEK": "rgb(255, 0, 0)",
    
    "Reform": "rgb(0, 128, 255)",
    "Kesk": "rgb(0, 128, 0)",
    "SDE": "rgb(255, 0, 0)",
    "IRL": "rgb(0, 0, 128)",
    "EKRE": "rgb(0, 0, 0)",
    
    "Vienotība": "rgb(0, 0, 128)",
    "ZZS": "rgb(0, 128, 0)",
    "NA": "rgb(0, 0, 0)",
    "Saskaņa": "rgb(255, 0, 0)",
    "KPV LV": "rgb(0, 128, 255)",
    
    "TS-LKD": "rgb(0, 0, 128)",
    "LSDP": "rgb(255, 0, 0)",
    "LVŽS": "rgb(0, 128, 0)",
    "LRLS": "rgb(0, 128, 255)",
    
    "CSV": "rgb(0, 0, 0)",
    "LSAP": "rgb(255, 0, 0)",
    "DP": "rgb(0, 128, 255)",
    "Déi Gréng": "rgb(0, 128, 0)",
    "Déi Lénk": "rgb(255, 0, 0)",
    
    "PN": "rgb(0, 0, 128)",
    "PL": "rgb(255, 0, 0)",
    "AD": "rgb(0, 128, 0)",
    
    "default": "rgb(128, 128, 128)"
};

function capitalizeWords(str) {
    return str.replace(/\b\w/g, l => l.toUpperCase());
}

function toggleSelection(element) {
    element.classList.toggle('selected');
    updateData();
}

function toggleCountryParties(countryHeader) {
    const countryColumn = countryHeader.parentElement;
    const partyItems = countryColumn.querySelectorAll('.select-item');
    const isSelected = countryHeader.classList.contains('selected');
    
    countryHeader.classList.toggle('selected');
    
    partyItems.forEach(item => {
        if (isSelected) {
            item.classList.remove('selected');
        } else {
            item.classList.add('selected');
        }
    });
    
    updateData();
}

function estimatePartyImportance(partyInfo) {
    if (!partyInfo) return 0;
    
    let importance = 0;
    
    if (partyInfo.family_name) {
        const familyName = partyInfo.family_name.toLowerCase();
        
        if (familyName.includes("social democratic") || familyName.includes("socialist")) {
            importance += 30;
        } else if (familyName.includes("conservative") || familyName.includes("christian democratic")) {
            importance += 30;
        } else if (familyName.includes("liberal")) {
            importance += 25;
        } else if (familyName.includes("green")) {
            importance += 20;
        } else if (familyName.includes("radical right") || familyName.includes("populist right")) {
            importance += 20;
        } else if (familyName.includes("communist") || familyName.includes("left")) {
            importance += 15;
        } else if (familyName.includes("regional")) {
            importance += 10;
        }
    }
    
    if (partyInfo.in_government === 1) {
        importance += 15;
    }
    
    if (partyInfo.in_parliament === 1) {
        importance += 10;
    }
    
    const partyName = partyInfo.party.toLowerCase();
    
    if (partyName.includes("national") || partyName.includes("democratic") || 
        partyName.includes("people") || partyName.includes("union") ||
        partyName.includes("republican") || partyName.includes("labour") ||
        partyName.includes("labor")) {
        importance += 5;
    }
    
    if (partyInfo.country_name) {
        const country = partyInfo.country_name.toLowerCase();
        
        if (country === "germany") {
            if (partyName.includes("cdu") || partyName.includes("csu") || 
                partyName.includes("spd") || partyName.includes("fdp") || 
                partyName.includes("die linke") || partyName.includes("grüne") ||
                partyName.includes("afd")) {
                importance += 10;
            }
        }
        else if (country === "france") {
            if (partyName.includes("républicain") || partyName.includes("socialiste") || 
                partyName.includes("en marche") || partyName.includes("rassemblement national") ||
                partyName.includes("les républicains") || partyName.includes("parti socialiste")) {
                importance += 10;
            }
        }
        else if (country === "united kingdom" || country === "uk") {
            if (partyName.includes("conservative") || partyName.includes("labour") || 
                partyName.includes("liberal democrat") || partyName.includes("scottish national") ||
                partyName.includes("snp") || partyName.includes("plaid cymru") ||
                partyName.includes("ukip") || partyName.includes("brexit")) {
                importance += 10;
            }
        }
        else if (country === "italy") {
            if (partyName.includes("forza italia") || partyName.includes("partito democratico") || 
                partyName.includes("lega") || partyName.includes("fratelli d'italia") ||
                partyName.includes("movimento 5 stelle")) {
                importance += 10;
            }
        }
        else if (country === "spain") {
            if (partyName.includes("partido popular") || partyName.includes("partido socialista") || 
                partyName.includes("ciudadanos") || partyName.includes("podemos") ||
                partyName.includes("vox")) {
                importance += 10;
            }
        }
        else if (country === "netherlands") {
            if (partyName.includes("vvd") || partyName.includes("cda") || 
                partyName.includes("pvda") || partyName.includes("d66") ||
                partyName.includes("pvdd") || partyName.includes("sp") ||
                partyName.includes("groenlinks") || partyName.includes("fvd")) {
                importance += 10;
            }
        }
        else if (country === "sweden") {
            if (partyName.includes("socialdemokraterna") || partyName.includes("moderaterna") || 
                partyName.includes("centerpartiet") || partyName.includes("vänsterpartiet") ||
                partyName.includes("kristdemokraterna") || partyName.includes("liberalerna") ||
                partyName.includes("miljöpartiet") || partyName.includes("sverigedemokraterna")) {
                importance += 10;
            }
        }
    }
    
    return importance;
}

async function loadPartyData() {
    try {
        console.log("Starting to load party data...");
        
        const dataResponse = await fetch('/files/party_issue_data.json');
        if (!dataResponse.ok) {
            throw new Error(`Failed to load party issue data: ${dataResponse.status} ${dataResponse.statusText}`);
        }
        allData = await dataResponse.json();
        console.log("Party issue data loaded successfully:", allData.length, "parties");
        
        const partyInfoResponse = await fetch('/files/party_info.json');
        if (!partyInfoResponse.ok) {
            throw new Error(`Failed to load party info: ${partyInfoResponse.status} ${partyInfoResponse.statusText}`);
        }
        partyInfo = await partyInfoResponse.json();
        console.log("Party info loaded successfully:", partyInfo.length, "party info entries");
        
        const partyList = document.getElementById('party-list');
        partyList.innerHTML = '';
        
        const partyInfoMap = {};
        partyInfo.forEach(info => {
            partyInfoMap[info.parlgov_id] = info;
        });
        
        const partiesByCountry = {};
        
        allData.forEach(party => {
            const partyId = party.p[0];
            const partyInfoItem = partyInfoMap[partyId];
            
            if (partyInfoItem) {
                let countryName = partyInfoItem.country_name;
                
                if (countryName.toLowerCase() === "united kingdom") {
                    countryName = "UK";
                }
                
                if (!partiesByCountry[countryName]) {
                    partiesByCountry[countryName] = [];
                }
                partiesByCountry[countryName].push({
                    id: partyId,
                    info: partyInfoItem
                });
            } else {
                if (!partiesByCountry['Other']) {
                    partiesByCountry['Other'] = [];
                }
                partiesByCountry['Other'].push({
                    id: partyId,
                    info: null
                });
            }
        });
        
        const sortedCountries = Object.keys(partiesByCountry).sort((a, b) => {
            return a.localeCompare(b);
        });
        
        console.log("Countries found:", sortedCountries);
        
        sortedCountries.forEach(country => {
            const countryColumn = document.createElement('div');
            countryColumn.className = 'country-column';
            
            const countryHeader = document.createElement('div');
            countryHeader.className = 'country-header';
            
            if (country === "UK") {
                countryHeader.textContent = "UK";
            } else {
                countryHeader.textContent = capitalizeWords(country);
            }
            
            countryHeader.onclick = function() { toggleCountryParties(this); };
            
            countryColumn.appendChild(countryHeader);
            
            partiesByCountry[country].sort((a, b) => {
                const aImportance = estimatePartyImportance(a.info);
                const bImportance = estimatePartyImportance(b.info);
                
                return bImportance - aImportance;
            });
            
            partiesByCountry[country].forEach(party => {
                const div = document.createElement('div');
                div.className = 'select-item';
                div.setAttribute('data-value', party.id);
                div.onclick = function() { toggleSelection(this); };
                
                let partyText;
                if (party.info) {
                    const partyName = party.info.party;
                    partyText = partyName;
                } else {
                    partyText = "Party";
                }
                
                div.textContent = partyText;
                countryColumn.appendChild(div);
            });
            
            partyList.appendChild(countryColumn);
        });
        
        console.log("Party list populated successfully");
        updateData();
    } catch (error) {
        console.error('Error loading data:', error);
        const partyList = document.getElementById('party-list');
        partyList.innerHTML = `<div class="select-item" style="color: red;">Error loading data: ${error.message}</div>`;
        
        if (error.message.includes("Failed to load")) {
            console.log("Attempting to load data from alternative paths...");
            try {
                const dataResponse = await fetch('./files/party_issue_data.json');
                if (!dataResponse.ok) {
                    throw new Error(`Failed to load party issue data from alternative path: ${dataResponse.status} ${dataResponse.statusText}`);
                }
                allData = await dataResponse.json();
                
                const partyInfoResponse = await fetch('./files/party_info.json');
                if (!partyInfoResponse.ok) {
                    throw new Error(`Failed to load party info from alternative path: ${partyInfoResponse.status} ${partyInfoResponse.statusText}`);
                }
                partyInfo = await partyInfoResponse.json();
                
                console.log("Successfully loaded data from alternative paths");
                loadPartyData();
            } catch (altError) {
                console.error('Error loading data from alternative paths:', altError);
                partyList.innerHTML = `<div class="select-item" style="color: red;">Error loading data: ${altError.message}</div>`;
            }
        }
    }
}

function toggleAllIssues() {
    const selectAll = !document.querySelector('#issue-list .select-item.selected');
    const items = document.querySelectorAll('#issue-list .select-item');
    
    items.forEach(item => {
        if (selectAll) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
    
    updateData();
}

function updateData() {
    const selectedParties = Array.from(document.querySelectorAll('#party-list .select-item.selected'))
        .map(item => parseInt(item.getAttribute('data-value')));
    
    const selectedIssues = Array.from(document.querySelectorAll('#issue-list .select-item.selected'))
        .map(item => item.getAttribute('data-value'));
    
    if (selectedParties.length === 0 || selectedIssues.length === 0) {
        return;
    }
    
    updateChart(selectedParties, selectedIssues);
}

function updateChart(selectedParties, selectedIssues) {
    const ctx = document.getElementById('issue-chart').getContext('2d');
    if (chart) {
        chart.destroy();
    }
    
    let datasets = [];
    let colorIndex = 0;
    
    const partyInfoMap = {};
    partyInfo.forEach(info => {
        partyInfoMap[info.parlgov_id] = info;
    });
    
    const allMonths = new Set();
    selectedParties.forEach(partyId => {
        const partyData = allData.find(item => item.p.includes(partyId));
        if (partyData) {
            partyData.d.forEach(item => {
                allMonths.add(item.m[0]);
            });
        }
    });
    
    const sortedMonths = Array.from(allMonths).sort();
    
    const monthToIndex = {};
    sortedMonths.forEach((month, index) => {
        monthToIndex[month] = index;
    });
    
    console.log("Smoothing enabled:", smoothingEnabled);
    console.log("Country averages enabled:", countryAveragesEnabled);
    
    if (countryAveragesEnabled) {
        try {
            datasets = calculateCountryAverages(selectedParties, selectedIssues);
            console.log("Country averages calculated, datasets:", datasets.length);
            
            if (datasets.length > 0) {
                console.log("First dataset sample:", {
                    label: datasets[0].label,
                    dataLength: datasets[0].data.length,
                    firstFewValues: datasets[0].data.slice(0, 5)
                });
            }
        } catch (error) {
            console.error("Error calculating country averages:", error);
        }
    } else {
        selectedParties.forEach(partyId => {
            const partyData = allData.find(item => item.p.includes(partyId));
            if (!partyData) return;
            
            selectedIssues.forEach(issueId => {
                const dataIssueId = issueId.includes('.') ? issueId.replace('.', '') : issueId;
                
                let data = new Array(sortedMonths.length).fill(null);
                
                partyData.d.forEach(item => {
                    const month = item.m[0];
                    const index = monthToIndex[month];
                    if (index !== undefined && item.i[dataIssueId] && item.i[dataIssueId][2] !== undefined) {
                        data[index] = item.i[dataIssueId][2] * 100;
                    }
                });
                
                if (smoothingEnabled) {
                    data = smoothData(data);
                }
                
                const partyInfoItem = partyInfoMap[partyId];
                const issueLabel = document.querySelector(`#issue-list .select-item[data-value="${issueId}"]`).textContent.trim();
                
                let datasetLabel;
                let borderColor;
                
                if (partyInfoItem) {
                    const partyName = partyInfoItem.party;
                    datasetLabel = `${partyName} (${partyId}) - ${issueLabel}`;
                    
                    if (selectedIssues.length === 1) {
                        borderColor = getPartyColor(partyName);
                    } else {
                        borderColor = colors[colorIndex % colors.length];
                    }
                } else {
                    datasetLabel = `Party (${partyId}) - ${issueLabel}`;
                    borderColor = colors[colorIndex % colors.length];
                }
                
                datasets.push({
                    label: datasetLabel,
                    data: data,
                    borderColor: borderColor,
                    tension: smoothingEnabled ? 0.3 : 0.1,
                    spanGaps: true,
                    pointRadius: 0,
                    pointStyle: 'none'
                });
                
                colorIndex++;
            });
        });
    }
    
    if (datasets.length === 0) {
        console.log("No datasets to display");
        return;
    }
    
    console.log("Creating chart with", datasets.length, "datasets");
    
    try {
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedMonths,
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Share (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                } else {
                                    label += 'No data';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        
        createCustomLegend(datasets);
        
        console.log("Chart created successfully");
    } catch (error) {
        console.error("Error creating chart:", error);
    }
}

function createCustomLegend(datasets) {
    console.log("Creating custom legend with", datasets.length, "datasets");
    const legendContainer = document.getElementById('chart-legend');
    
    legendContainer.innerHTML = '';
    
    datasets.forEach((dataset, index) => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.setAttribute('data-index', index);
        
        const colorBox = document.createElement('div');
        colorBox.className = 'legend-color';
        colorBox.style.backgroundColor = dataset.borderColor;
        
        const label = document.createElement('span');
        label.textContent = dataset.label;
        
        legendItem.appendChild(colorBox);
        legendItem.appendChild(label);
        
        legendItem.addEventListener('click', function() {
            const datasetIndex = parseInt(this.getAttribute('data-index'));
            const meta = chart.getDatasetMeta(datasetIndex);
            
            meta.hidden = meta.hidden === null ? !chart.data.datasets[datasetIndex].hidden : null;
            chart.update();
            
            this.classList.toggle('legend-hidden');
        });
        
        legendContainer.appendChild(legendItem);
    });
    
    legendContainer.style.display = 'flex';
    
    if (datasets.length > 20) {
        const scrollMessage = document.createElement('div');
        scrollMessage.style.width = '100%';
        scrollMessage.style.textAlign = 'center';
        scrollMessage.style.fontSize = '0.8em';
        scrollMessage.style.color = '#666';
        scrollMessage.style.marginTop = '5px';
        scrollMessage.textContent = 'Scroll to see more items';
        legendContainer.appendChild(scrollMessage);
    }
    
    console.log("Legend created with", legendContainer.children.length, "items");
}

function toggleSmoothing() {
    smoothingEnabled = !smoothingEnabled;
    const button = document.getElementById('smooth-button');
    if (smoothingEnabled) {
        button.classList.add('active');
    } else {
        button.classList.remove('active');
    }
    updateData();
}

function toggleCountryAverages() {
    countryAveragesEnabled = !countryAveragesEnabled;
    const button = document.getElementById('country-avg-button');
    if (countryAveragesEnabled) {
        button.classList.add('active');
    } else {
        button.classList.remove('active');
    }
    updateData();
}

function calculateCountryAverages(selectedParties, selectedIssues) {
    const partiesByCountry = {};
    
    selectedParties.forEach(partyId => {
        const partyInfoItem = partyInfo.find(info => info.parlgov_id === partyId);
        if (!partyInfoItem) return;
        
        let countryName = partyInfoItem.country_name;
        
        if (countryName.toLowerCase() === "united kingdom") {
            countryName = "UK";
        }
        
        if (!partiesByCountry[countryName]) {
            partiesByCountry[countryName] = [];
        }
        partiesByCountry[countryName].push(partyId);
    });
    
    console.log("Parties by country:", partiesByCountry);
    
    const datasets = [];
    let colorIndex = 0;
    
    const allMonths = new Set();
    selectedParties.forEach(partyId => {
        const partyData = allData.find(item => item.p.includes(partyId));
        if (partyData) {
            partyData.d.forEach(item => {
                allMonths.add(item.m[0]);
            });
        }
    });
    
    const sortedMonths = Array.from(allMonths).sort();
    console.log("Total months:", sortedMonths.length);
    
    const monthToIndex = {};
    sortedMonths.forEach((month, index) => {
        monthToIndex[month] = index;
    });
    
    Object.keys(partiesByCountry).forEach(country => {
        const countryPartyIds = partiesByCountry[country];
        
        console.log(`Processing ${country} with ${countryPartyIds.length} parties`);
        
        selectedIssues.forEach(issueId => {
            const dataIssueId = issueId.includes('.') ? issueId.replace('.', '') : issueId;
            
            let data = new Array(sortedMonths.length).fill(null);
            const counts = new Array(sortedMonths.length).fill(0);
            
            countryPartyIds.forEach(partyId => {
                const partyData = allData.find(item => item.p.includes(partyId));
                if (!partyData) return;
                
                partyData.d.forEach(item => {
                    const month = item.m[0];
                    const index = monthToIndex[month];
                    if (index !== undefined && item.i[dataIssueId] && item.i[dataIssueId][2] !== undefined) {
                        if (data[index] === null) {
                            data[index] = 0;
                        }
                        data[index] += item.i[dataIssueId][2] * 100;
                        counts[index]++;
                    }
                });
            });
            
            for (let i = 0; i < data.length; i++) {
                if (counts[i] > 0) {
                    data[i] = data[i] / counts[i];
                } else {
                    data[i] = null;
                }
            }
            
            if (smoothingEnabled) {
                console.log(`Applying smoothing to ${country} - ${issueId}`);
                data = smoothData(data);
            }
            
            const issueLabel = document.querySelector(`#issue-list .select-item[data-value="${issueId}"]`).textContent.trim();
            
            const formattedCountryName = country === "UK" ? "UK" : capitalizeWords(country);
            const datasetLabel = `${formattedCountryName} Within-Country Average - ${issueLabel}`;
            
            let borderColor;
            if (selectedIssues.length === 1) {
                const dominantParty = findDominantParty(country, countryPartyIds);
                if (dominantParty) {
                    borderColor = getPartyColor(dominantParty);
                } else {
                    borderColor = colors[colorIndex % colors.length];
                }
            } else {
                borderColor = colors[colorIndex % colors.length];
            }
            
            datasets.push({
                label: datasetLabel,
                data: data,
                borderColor: borderColor,
                tension: smoothingEnabled ? 0.3 : 0.1,
                spanGaps: true,
                borderWidth: 2,
                pointRadius: 0,
                pointStyle: 'none'
            });
            
            colorIndex++;
        });
    });
    
    console.log("Returning", datasets.length, "country average datasets");
    return datasets;
}

function findDominantParty(country, partyIds) {
    const countryParties = partyIds.map(id => {
        return partyInfo.find(info => info.parlgov_id === id);
    }).filter(Boolean);
    
    if (countryParties.length === 0) return null;
    
    countryParties.sort((a, b) => {
        return estimatePartyImportance(b) - estimatePartyImportance(a);
    });
    
    return countryParties[0].party;
}

function smoothData(data, windowSize = 5) {
    if (data.length < windowSize) return data;
    
    const smoothed = new Array(data.length);
    
    for (let i = 0; i < data.length; i++) {
        if (data[i] === null) {
            smoothed[i] = null;
            continue;
        }
        
        let sum = data[i];
        let count = 1;
        
        for (let j = 1; j <= Math.floor(windowSize / 2); j++) {
            if (i - j >= 0 && data[i - j] !== null) {
                sum += data[i - j];
                count++;
            }
        }
        
        for (let j = 1; j <= Math.floor(windowSize / 2); j++) {
            if (i + j < data.length && data[i + j] !== null) {
                sum += data[i + j];
                count++;
            }
        }
        
        smoothed[i] = sum / count;
    }
    
    return smoothed;
}

function getPartyColor(partyName) {
    if (!partyName) return colors[0];
    
    for (const knownParty in partyColors) {
        if (partyName.toLowerCase().includes(knownParty.toLowerCase())) {
            return partyColors[knownParty];
        }
    }
    
    const partyInfoItem = partyInfo.find(info => info.party === partyName);
    if (partyInfoItem && partyInfoItem.family_name) {
        const familyName = partyInfoItem.family_name.toLowerCase();
        
        if (familyName.includes("social democratic") || familyName.includes("socialist")) {
            return "rgb(255, 0, 0)";
        } else if (familyName.includes("conservative") || familyName.includes("christian democratic")) {
            return "rgb(0, 0, 128)";
        } else if (familyName.includes("liberal")) {
            return "rgb(0, 128, 255)";
        } else if (familyName.includes("green")) {
            return "rgb(0, 128, 0)";
        } else if (familyName.includes("radical right") || familyName.includes("populist right")) {
            return "rgb(0, 0, 0)";
        } else if (familyName.includes("communist") || familyName.includes("left")) {
            return "rgb(128, 0, 128)";
        } else if (familyName.includes("regional")) {
            return "rgb(255, 215, 0)";
        }
    }
    
    return partyColors.default;
}

function exportToCSV() {
    if (!chart || !chart.data || !chart.data.datasets || chart.data.datasets.length === 0) {
        alert("No data available to export");
        return;
    }
    
    const datasets = chart.data.datasets;
    const labels = chart.data.labels;
    
    let csvContent = "Month";
    
    datasets.forEach(dataset => {
        csvContent += `,"${dataset.label}"`;
    });
    
    csvContent += "\n";
    
    for (let i = 0; i < labels.length; i++) {
        csvContent += labels[i];
        
        datasets.forEach(dataset => {
            const value = dataset.data[i];
            csvContent += `,${value === null ? "" : value.toFixed(2)}`;
        });
        
        csvContent += "\n";
    }
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        
        let filename = "party_press_data";
        
        const selectedIssues = Array.from(document.querySelectorAll('#issue-list .select-item.selected'))
            .map(item => item.textContent.trim().replace(/\s+/g, '_'));
        
        if (selectedIssues.length > 0) {
            filename += "_" + selectedIssues.join("_");
        }
        
        const now = new Date();
        filename += "_" + now.getFullYear() + "-" + 
                   (now.getMonth() + 1).toString().padStart(2, '0') + "-" + 
                   now.getDate().toString().padStart(2, '0');
        
        link.setAttribute("download", filename + ".csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadPartyData();
    
    setTimeout(function() {
        const housingIssue = document.querySelector('#issue-list .select-item[data-value="14"]');
        const immigrationIssue = document.querySelector('#issue-list .select-item[data-value="9"]');
        
        if (housingIssue) housingIssue.classList.add('selected');
        if (immigrationIssue) immigrationIssue.classList.add('selected');
        
        smoothingEnabled = true;
        document.getElementById('smooth-button').classList.add('active');
        
        countryAveragesEnabled = true;
        document.getElementById('country-avg-button').classList.add('active');
        
        const germanParties = document.querySelectorAll('#party-list .country-column');
        germanParties.forEach(column => {
            const header = column.querySelector('.country-header');
            if (header && header.textContent === 'Germany') {
                header.classList.add('selected');
                
                const partyItems = column.querySelectorAll('.select-item');
                partyItems.forEach(item => {
                    item.classList.add('selected');
                });
            }
        });
        
        updateData();
    }, 1000);
});
</script>
</body>
</html> 